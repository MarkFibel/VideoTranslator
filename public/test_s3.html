<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yandex S3 Storage Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        h1 {
            color: #333;
            border-bottom: 3px solid #4caf50;
            padding-bottom: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            padding: 10px 20px;
            background-color: #f0f0f0;
            border: none;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .tab.active {
            background-color: #4caf50;
            color: white;
        }

        .tab:hover:not(.active) {
            background-color: #e0e0e0;
        }

        .tab-content {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .operation-form {
            border: 2px dashed #ccc;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="file"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background-color: #4caf50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover:not(:disabled) {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .progress-container {
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background-color: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50 0%, #45a049 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .stage-info {
            margin-top: 10px;
            font-weight: bold;
            color: #555;
        }

        .eta-info {
            margin-top: 5px;
            font-size: 14px;
            color: #777;
        }

        .log {
            background-color: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid #333;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            border-radius: 5px;
        }

        .log .timestamp {
            color: #858585;
        }

        .log .event-progress {
            color: #4ec9b0;
        }

        .log .event-complete {
            color: #4caf50;
            font-weight: bold;
        }

        .log .event-error {
            color: #f48771;
            font-weight: bold;
        }

        .log .stage {
            color: #dcdcaa;
        }

        .status {
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.processing {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .result-box {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: none;
        }

        .result-box h4 {
            margin-top: 0;
            color: #333;
        }

        .result-field {
            margin: 10px 0;
            font-family: monospace;
        }

        .result-field strong {
            color: #555;
        }

        .result-url {
            color: #0066cc;
            word-break: break-all;
        }

        .clear-btn {
            background-color: #ff9800;
            margin-left: 10px;
        }

        .clear-btn:hover {
            background-color: #e68900;
        }
    </style>
</head>

<body>
    <h1>üóÑÔ∏è Yandex Object Storage (S3) - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('upload')">üì§ –ó–∞–≥—Ä—É–∑–∫–∞</button>
        <button class="tab" onclick="switchTab('download')">üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ</button>
        <button class="tab" onclick="switchTab('delete')">üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ</button>
    </div>

    <!-- Upload Tab -->
    <div id="upload-tab" class="tab-content active">
        <div class="operation-form">
            <h3>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ Object Storage</h3>
            <div class="form-group">
                <label for="uploadFile">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª:</label>
                <input type="file" id="uploadFile">
            </div>
            <div class="form-group">
                <label for="uploadObjectKey">–ö–ª—é—á –æ–±—ä–µ–∫—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                <input type="text" id="uploadObjectKey" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏–º–µ–Ω–∏">
            </div>
            <div class="form-group">
                <label for="uploadContentType">Content-Type (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                <input type="text" id="uploadContentType" placeholder="application/octet-stream">
            </div>
            <button onclick="startUpload()" id="uploadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ S3</button>
            <button onclick="clearLog()" class="clear-btn">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        </div>

        <div class="progress-container" id="uploadProgress">
            <h3>–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="uploadProgressFill">0%</div>
            </div>
            <div class="stage-info" id="uploadStageLabel">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
            <div class="eta-info" id="uploadEtaLabel"></div>
        </div>

        <div class="status" id="uploadStatus"></div>

        <div class="result-box" id="uploadResult">
            <h4>‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≥—Ä—É–∑–∫–∏</h4>
            <div id="uploadResultContent"></div>
        </div>
    </div>

    <!-- Download Tab -->
    <div id="download-tab" class="tab-content">
        <div class="operation-form">
            <h3>–°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ Object Storage</h3>
            <div class="form-group">
                <label for="downloadObjectKey">–ö–ª—é—á –æ–±—ä–µ–∫—Ç–∞:</label>
                <input type="text" id="downloadObjectKey" placeholder="example.txt">
            </div>
            <div class="form-group">
                <label for="downloadFileName">–ò–º—è —Ñ–∞–π–ª–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:</label>
                <input type="text" id="downloadFileName" placeholder="downloaded_file.txt">
            </div>
            <button onclick="startDownload()" id="downloadBtn">–°–∫–∞—á–∞—Ç—å –∏–∑ S3</button>
            <button onclick="clearLog()" class="clear-btn">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        </div>

        <div class="progress-container" id="downloadProgress">
            <h3>–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–∫–∞—á–∏–≤–∞–Ω–∏—è</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="downloadProgressFill">0%</div>
            </div>
            <div class="stage-info" id="downloadStageLabel">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
            <div class="eta-info" id="downloadEtaLabel"></div>
        </div>

        <div class="status" id="downloadStatus"></div>

        <div class="result-box" id="downloadResult">
            <h4>‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏—è</h4>
            <div id="downloadResultContent"></div>
        </div>
    </div>

    <!-- Delete Tab -->
    <div id="delete-tab" class="tab-content">
        <div class="operation-form">
            <h3>–£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ Object Storage</h3>
            <div class="form-group">
                <label for="deleteObjectKey">–ö–ª—é—á –æ–±—ä–µ–∫—Ç–∞:</label>
                <input type="text" id="deleteObjectKey" placeholder="example.txt">
            </div>
            <div class="form-group">
                <label for="deleteVersionId">Version ID (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                <input type="text" id="deleteVersionId" placeholder="–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ">
            </div>
            <button onclick="startDelete()" id="deleteBtn">–£–¥–∞–ª–∏—Ç—å –∏–∑ S3</button>
            <button onclick="clearLog()" class="clear-btn">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        </div>

        <div class="progress-container" id="deleteProgress">
            <h3>–ü—Ä–æ–≥—Ä–µ—Å—Å —É–¥–∞–ª–µ–Ω–∏—è</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="deleteProgressFill">0%</div>
            </div>
            <div class="stage-info" id="deleteStageLabel">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
        </div>

        <div class="status" id="deleteStatus"></div>

        <div class="result-box" id="deleteResult">
            <h4>‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —É–¥–∞–ª–µ–Ω–∏—è</h4>
            <div id="deleteResultContent"></div>
        </div>
    </div>

    <h3>üìã –õ–æ–≥ —Å–æ–±—ã—Ç–∏–π SSE</h3>
    <div class="log" id="logArea">–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π...\n</div>

    <script>
        let currentOperation = null;

        // –°–ª–æ–≤–∞—Ä—å —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π —ç—Ç–∞–ø–æ–≤
        const stageLabels = {
            'initializing': 'üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è',
            'authenticating': 'üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è',
            'preparing': 'üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞',
            'processing': '‚öôÔ∏è –û–±—Ä–∞–±–æ—Ç–∫–∞',
            'finalizing': '‚ú® –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ',
            'multipart_init': 'üîÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è multipart',
            'multipart_upload': 'üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Å—Ç–µ–π',
            'multipart_complete': 'üéØ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ multipart',
            'metadata_fetch': 'üìÑ –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö',
            'streaming_download': 'üíæ –ü–æ—Ç–æ–∫–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞',
            'complete': '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ',
            'error': '‚ùå –û—à–∏–±–∫–∞'
        };

        function switchTab(tab) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é
            document.getElementById(`${tab}-tab`).classList.add('active');
            event.target.classList.add('active');

            currentOperation = tab;
        }

        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            let className = '';

            if (message.includes('progress:')) className = 'event-progress';
            if (message.includes('‚úÖ') || message.includes('Complete')) className = 'event-complete';
            if (message.includes('‚ùå') || message.includes('Error')) className = 'event-error';
            if (message.includes('stage:')) className = 'stage';

            const line = `<span class="timestamp">[${timestamp}]</span> <span class="${className}">${escapeHtml(message)}</span>\n`;
            logArea.innerHTML += line;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function clearLog() {
            document.getElementById('logArea').innerHTML = '–õ–æ–≥ –æ—á–∏—â–µ–Ω...\n';
        }

        function showStatus(message, type, operation) {
            const statusEl = document.getElementById(`${operation}Status`);
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
        }

        function updateProgress(progress, stage, operation, details = null) {
            const progressFill = document.getElementById(`${operation}ProgressFill`);
            const stageLabel = document.getElementById(`${operation}StageLabel`);
            const etaLabel = document.getElementById(`${operation}EtaLabel`);

            progressFill.style.width = `${progress}%`;
            progressFill.textContent = `${progress}%`;

            const label = stageLabels[stage] || stage || '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
            stageLabel.textContent = label;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º ETA –∏ –ø–æ–¥—Å—Ç–∞–¥–∏–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (details) {
                let etaText = '';
                if (details.current_step && details.total_steps) {
                    etaText += `–®–∞–≥ ${details.current_step} –∏–∑ ${details.total_steps}`;
                }
                if (details.eta_seconds) {
                    const minutes = Math.floor(details.eta_seconds / 60);
                    const seconds = details.eta_seconds % 60;
                    etaText += ` | ETA: ${minutes}m ${seconds}s`;
                }
                etaLabel.textContent = etaText;
            } else {
                etaLabel.textContent = '';
            }
        }

        function showResult(result, operation) {
            const resultBox = document.getElementById(`${operation}Result`);
            const resultContent = document.getElementById(`${operation}ResultContent`);

            let html = '';

            if (operation === 'upload') {
                html = `
                    <div class="result-field"><strong>–û–±—ä–µ–∫—Ç:</strong> ${result.object_key}</div>
                    <div class="result-field"><strong>–ë–∞–∫–µ—Ç:</strong> ${result.bucket}</div>
                    <div class="result-field"><strong>–†–∞–∑–º–µ—Ä:</strong> ${formatBytes(result.size)}</div>
                    <div class="result-field"><strong>URL:</strong> <a href="${result.url}" target="_blank" class="result-url">${result.url}</a></div>
                    <div class="result-field"><strong>ETag:</strong> ${result.etag}</div>
                    <div class="result-field"><strong>–ó–∞–≥—Ä—É–∂–µ–Ω–æ:</strong> ${result.uploaded_at}</div>
                    ${result.multipart ? '<div class="result-field"><strong>Multipart:</strong> ‚úÖ –î–∞ (—á–∞—Å—Ç–µ–π: ' + result.parts_count + ')</div>' : ''}
                `;
            } else if (operation === 'download') {
                html = `
                    <div class="result-field"><strong>–û–±—ä–µ–∫—Ç:</strong> ${result.object_key}</div>
                    <div class="result-field"><strong>–°–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫:</strong> ${result.destination_path}</div>
                    <div class="result-field"><strong>–†–∞–∑–º–µ—Ä:</strong> ${formatBytes(result.size)}</div>
                    <div class="result-field"><strong>ETag:</strong> ${result.etag}</div>
                    <div class="result-field"><strong>Content-Type:</strong> ${result.content_type}</div>
                    <div class="result-field"><strong>–°–∫–∞—á–∞–Ω–æ:</strong> ${result.downloaded_at}</div>
                `;
            } else if (operation === 'delete') {
                html = `
                    <div class="result-field"><strong>–û–±—ä–µ–∫—Ç:</strong> ${result.object_key}</div>
                    <div class="result-field"><strong>–ë–∞–∫–µ—Ç:</strong> ${result.bucket}</div>
                    <div class="result-field"><strong>–°—Ç–∞—Ç—É—Å:</strong> ${result.deleted ? '‚úÖ –£–¥–∞–ª–µ–Ω' : '‚ùå –ù–µ —É–¥–∞–ª–µ–Ω'}</div>
                    <div class="result-field"><strong>–£–¥–∞–ª–µ–Ω–æ:</strong> ${result.deleted_at}</div>
                    ${result.version_id ? '<div class="result-field"><strong>Version ID:</strong> ' + result.version_id + '</div>' : ''}
                `;
            }

            resultContent.innerHTML = html;
            resultBox.style.display = 'block';
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        async function startUpload() {
            const fileInput = document.getElementById('uploadFile');
            const objectKey = document.getElementById('uploadObjectKey').value.trim();
            const contentType = document.getElementById('uploadContentType').value.trim();
            const uploadBtn = document.getElementById('uploadBtn');
            const progressContainer = document.getElementById('uploadProgress');

            if (!fileInput.files[0]) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
                return;
            }

            const file = fileInput.files[0];
            log(`üöÄ –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ${file.name} (${formatBytes(file.size)})`);

            progressContainer.style.display = 'block';
            uploadBtn.disabled = true;
            showStatus('–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤ Object Storage...', 'processing', 'upload');

            try {
                const formData = new FormData();
                formData.append('operation', 'upload');
                formData.append('file', file);
                if (objectKey) formData.append('object_key', objectKey);
                if (contentType) formData.append('content_type', contentType);

                await processSSEStream('/api/s3/stream', formData, 'upload');

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`);
                showStatus(`–û—à–∏–±–∫–∞: ${error.message}`, 'error', 'upload');
                uploadBtn.disabled = false;
            }
        }

        async function startDownload() {
            const objectKey = document.getElementById('downloadObjectKey').value.trim();
            const fileName = document.getElementById('downloadFileName').value.trim();
            const downloadBtn = document.getElementById('downloadBtn');
            const progressContainer = document.getElementById('downloadProgress');

            if (!objectKey) {
                alert('–£–∫–∞–∂–∏—Ç–µ –∫–ª—é—á –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
                return;
            }

            log(`üöÄ –ù–∞—á–∞–ª–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞: ${objectKey}`);

            progressContainer.style.display = 'block';
            downloadBtn.disabled = true;
            showStatus('–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–∑ Object Storage...', 'processing', 'download');

            try {
                const formData = new FormData();
                formData.append('operation', 'download');
                formData.append('object_key', objectKey);
                formData.append('destination_path', fileName || objectKey);

                await processSSEStream('/api/s3/stream', formData, 'download');

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: ${error.message}`);
                showStatus(`–û—à–∏–±–∫–∞: ${error.message}`, 'error', 'download');
                downloadBtn.disabled = false;
            }
        }

        async function startDelete() {
            const objectKey = document.getElementById('deleteObjectKey').value.trim();
            const versionId = document.getElementById('deleteVersionId').value.trim();
            const deleteBtn = document.getElementById('deleteBtn');
            const progressContainer = document.getElementById('deleteProgress');

            if (!objectKey) {
                alert('–£–∫–∞–∂–∏—Ç–µ –∫–ª—é—á –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }

            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç "${objectKey}"?`)) {
                return;
            }

            log(`üöÄ –ù–∞—á–∞–ª–æ —É–¥–∞–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞: ${objectKey}`);

            progressContainer.style.display = 'block';
            deleteBtn.disabled = true;
            showStatus('–£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ Object Storage...', 'processing', 'delete');

            try {
                const formData = new FormData();
                formData.append('operation', 'delete');
                formData.append('object_key', objectKey);
                if (versionId) formData.append('version_id', versionId);

                await processSSEStream('/api/s3/stream', formData, 'delete');

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${error.message}`);
                showStatus(`–û—à–∏–±–∫–∞: ${error.message}`, 'error', 'delete');
                deleteBtn.disabled = false;
            }
        }

        async function processSSEStream(url, formData, operation) {
            const response = await fetch(url, {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            log(`‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –ß—Ç–µ–Ω–∏–µ SSE –ø–æ—Ç–æ–∫–∞...`);

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();

                if (done) {
                    log('üèÅ –ü–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
                    break;
                }

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n\n');
                buffer = lines.pop();

                for (const message of lines) {
                    if (!message.trim()) continue;

                    try {
                        const eventLines = message.split('\n');
                        let eventType = 'message';
                        let eventData = '';

                        for (const line of eventLines) {
                            if (line.startsWith('event: ')) {
                                eventType = line.substring(7);
                            } else if (line.startsWith('data: ')) {
                                eventData = line.substring(6);
                            }
                        }

                        if (!eventData) continue;

                        const data = JSON.parse(eventData);

                        log(`üì® Event [${eventType}]: progress=${data.progress}, stage=${data.stage}`);

                        if (eventType === 'progress') {
                            updateProgress(data.progress, data.stage, operation, data.details);
                            const label = stageLabels[data.stage] || data.stage;
                            showStatus(`${data.progress}% - ${label}`, 'processing', operation);
                        } else if (eventType === 'complete') {
                            log(`‚úÖ –û–ø–µ—Ä–∞—Ü–∏—è ${operation} —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞`);
                            updateProgress(100, 'complete', operation);
                            showStatus('–û–ø–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!', 'success', operation);
                            showResult(data.result, operation);
                            document.getElementById(`${operation}Btn`).disabled = false;
                        } else if (eventType === 'error') {
                            const errorMsg = data.error?.message || 'Unknown error';
                            log(`‚ùå –û—à–∏–±–∫–∞: ${errorMsg}`);
                            showStatus(`–û—à–∏–±–∫–∞: ${errorMsg}`, 'error', operation);
                            document.getElementById(`${operation}Btn`).disabled = false;
                            break;
                        }
                    } catch (e) {
                        log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ SSE: ${e.message}`);
                    }
                }
            }
        }
    </script>
</body>

</html>