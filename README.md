# VideoTranslator

Общее описание проекта 

## Описание Нейронки

...

## Описание Фронта

...

## Бекенд архитектура

![Backend Architecture](./docs/backend_architecture.png)

Бэкенд состоит из двух основных частей: API сервер и обработчики сервисов.
API сервер отвечает за обработку HTTP запросов и маршрутизацию.
Обработчики сервисов реализуют бизнес-логику и взаимодействие с внешними системами.

### Технологический стек

**Основные технологии:**
- **FastAPI** - современный, высокопроизводительный веб-фреймворк для построения API
- **Python 3.12+** - актуальная версия Python с улучшенной производительностью
- **Asyncio** - асинхронное программирование для эффективной обработки конкурентных запросов
- **aio-pika** - асинхронный клиент для работы с RabbitMQ
- **jsonrpc-py** - реализация JSON-RPC протокола для упрощения межсервисного взаимодействия

**Дополнительные библиотеки:**
- **Pydantic** - валидация данных и управление настройками
- **Uvicorn** - ASGI сервер для запуска приложения
- **python-multipart** - обработка загрузки файлов
- **aiofiles** - асинхронная работа с файловой системой

### Структура проекта

```
src/
├── app.py                    # Главный файл приложения, инициализация FastAPI
├── routes.py                 # Объединение всех роутеров
├── config/                   # Конфигурация приложения
│   ├── app_config.py         # Основные настройки (размер файлов, порты, и т.д.)
│   └── logging_config.py     # Настройка системы логирования
├── routers/                  # HTTP роутеры (endpoints)
│   ├── file_router.py        # Endpoints для работы с файлами
│   └── frontend_router.py    # Endpoints для фронтенда
├── services/                 # Бизнес-логика и сервисы
│   └── file_service.py       # Сервис обработки файлов
├── schemas/                  # Pydantic модели для валидации
│   ├── base_schema.py        # Базовые схемы
│   └── response_schema.py    # Схемы ответов API
├── exceptions/               # Пользовательские исключения
└── interfaces/               # Интерфейсы и абстракции
```

### API сервер

API сервер реализован с использованием FastAPI и является точкой входа для всех HTTP запросов. Основные компоненты:

#### Инициализация приложения (`app.py`)

Приложение инициализируется через фабричную функцию `get_application()`, которая:
- Настраивает FastAPI с указанием названия проекта, версии и режима отладки
- Подключает все роутеры через централизованную функцию `get_apps_router()`
- Монтирует статические файлы из директории `public/` для обслуживания фронтенда
- Инициализирует систему логирования с настройками из конфигурации

```python
app = get_application()
# Запуск: uvicorn src.app:app --host 0.0.0.0 --port 8000
```

#### Система маршрутизации

Маршрутизация организована модульно через отдельные роутеры:

**Frontend Router** (`frontend_router.py`):
- Обслуживает главную страницу приложения
- Автоматически выдает HTML контент с поддержкой CSRF защиты
- Endpoint: `GET /` - возвращает `index.html`

**File Router** (`file_router.py`):
- Обрабатывает загрузку файлов от пользователей
- Endpoint: `POST /files/upload` - принимает multipart/form-data с файлом
- Валидирует размер файла (макс. 10MB по умолчанию)
- Возвращает метаданные загруженного файла (имя, тип, размер, время загрузки)
- В будущем будет отправлять задачи в очередь RabbitMQ для фоновой обработки

#### Конфигурация (`config/`)

**Настройки приложения** (`app_config.py`):
Использует Pydantic Settings для управления конфигурацией с поддержкой `.env` файлов:
- `PROJECT_NAME` - название проекта
- `VERSION` - версия API
- `DEBUG` - режим отладки
- `LOG_LEVEL` - уровень логирования (DEBUG, INFO, WARNING, ERROR)
- `LOG_DIR` - директория для файлов логов
- `MAX_FILE_SIZE` - максимальный размер загружаемого файла (10MB)

**Система логирования** (`logging_config.py`):
Комплексная система логирования с несколькими обработчиками:
- **Console Handler** - вывод в консоль для разработки
- **File Info Handler** - запись общих логов в `var/log/app.log` с ротацией (5 файлов по 10MB)
- **File Error Handler** - отдельный файл `var/log/error.log` только для ошибок
- Структурированный формат логов с временными метками, именем модуля и номером строки
- Специальная конфигурация для логгеров uvicorn и fastapi

#### Схемы данных (`schemas/`)

Используются Pydantic модели для валидации входящих и исходящих данных:

**BaseResponse** - базовая схема для всех ответов API:
```python
{
    "status": "success" | "error",
    "message": "Описание результата",
    "error": "Детали ошибки (если есть)"
}
```

**FileUploadResponse** - расширенная схема для загрузки файлов:
```python
{
    "status": "success",
    "message": "File uploaded successfully",
    "data": {
        "filename": "video.mp4",
        "content_type": "video/mp4",
        "size": 1048576,
        "upload_time": "2025-10-18T12:00:00"
    }
}
```

#### Обработка ошибок

Реализована централизованная обработка исключений:
- HTTP ошибки выбрасываются через `HTTPException` с соответствующими статус-кодами
- Все неожиданные ошибки логируются с полным стек-трейсом
- Клиент получает структурированный JSON ответ даже при ошибках
- Используются стандартные HTTP статус-коды (400, 404, 500 и т.д.)

### Обработчики сервисов

Обработчики сервисов реализуют бизнес-логику приложения и работают асинхронно. Архитектура основана на паттерне **микросервисов с очередью сообщений**.

#### Принципы работы

**Асинхронная обработка:**
- Все операции выполняются асинхронно с использованием `async/await`
- Позволяет обрабатывать множество запросов одновременно без блокировки
- Эффективное использование ресурсов сервера

**Взаимодействие через очередь сообщений:**
- **RabbitMQ** выступает в роли брокера сообщений между API сервером и обработчиками
- **aio-pika** обеспечивает асинхронную работу с RabbitMQ
- API сервер отправляет задачи в очередь и сразу возвращает ответ клиенту
- Обработчики независимо забирают задачи из очереди и выполняют их
- Поддержка масштабирования - можно запустить несколько экземпляров обработчиков

**JSON-RPC протокол:**
- Использует **jsonrpc-py** для стандартизированного вызова методов
- Упрощает межсервисное взаимодействие
- Позволяет вызывать методы удаленных сервисов как локальные функции
- Поддержка передачи параметров и получения результатов в JSON формате

#### Архитектура обработчиков

Каждый обработчик (например, gunicorn App 1, App 2, App 3 на диаграмме) может представлять отдельный сервис:
- **Video Processing Service** - обработка и конвертация видео
- **Translation Service** - перевод аудио/субтитров
- **Storage Service** - сохранение результатов обработки

**Горизонтальное масштабирование:**
- Каждый сервис может иметь несколько инстансов (Inst.1, Inst.2, Inst.n)
- Нагрузка автоматически распределяется между инстансами
- При росте нагрузки можно добавить новые инстансы без изменения кода


## Установка и запуск

...