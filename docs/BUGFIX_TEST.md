# Тест исправления бага с сессией

## Быстрая проверка

### Тест 1: Обновление страницы во время обработки

```bash
# 1. Запустите сервер
python -m src.app

# 2. Откройте http://localhost:8000
# 3. Загрузите файл
# 4. СРАЗУ обновите страницу (F5) не дожидаясь завершения
# 5. Проверьте что отображается "Обработка файла..." (спиннер)
# 6. Дождитесь завершения обработки
# 7. Обновите страницу снова
# 8. Проверьте что отображается кнопка "Скачать видео"
```

**Ожидаемый результат:** ✅ Состояние восстановлено корректно

### Тест 2: Попытка загрузки нового файла

```bash
# После Теста 1:
# 1. НЕ скачивая файл, попробуйте загрузить новый файл
# 2. Должна появиться ошибка "Скачайте предыдущий файл..."
# 3. Скачайте файл
# 4. Попробуйте загрузить новый файл
```

**Ожидаемый результат:** ✅ После скачивания можно загружать новые файлы

### Тест 3: Проверка API статуса

```powershell
# Проверяйте статус на разных этапах
Invoke-WebRequest -Uri "http://localhost:8000/files/session/status" | Select-Object -ExpandProperty Content

# Перед загрузкой:
# {"pending":false,"need_download":false,"file":null}

# Во время обработки:
# {"pending":true,"need_download":false,"file":null}

# После обработки:
# {"pending":false,"need_download":true,"file":{...}}

# После скачивания:
# {"pending":false,"need_download":false,"file":{...}}
```

## Проверка исправления бага

### Сценарий воспроизведения бага (ДО исправления):

1. Загрузить файл
2. Обновить страницу во время обработки
3. Попытаться загрузить новый файл
4. ❌ Получить ошибку "FILE_PROCESSING"
5. ❌ Невозможно загрузить новые файлы

### Проверка что баг исправлен (ПОСЛЕ исправления):

1. Загрузить файл
2. Обновить страницу во время обработки
3. Дождаться завершения или скачать файл
4. Попытаться загрузить новый файл
5. ✅ Файл загружается успешно

## Логи для проверки

Откройте `var/log/app.log` и найдите:

```
INFO - Session status requested.
INFO - Session status: pending=False, need_download=True
```

При ошибках должно быть:

```
ERROR - Critical error in SSE event generator: ...
INFO - Temp file removed after critical error: ...
```

## Критерии успеха

✅ Обновление страницы не ломает состояние сессии  
✅ После ошибки можно загрузить новый файл  
✅ Временные файлы удаляются при ошибках  
✅ `pending=True` не "застревает" навсегда  
✅ API `/files/session/status` возвращает корректные данные  
